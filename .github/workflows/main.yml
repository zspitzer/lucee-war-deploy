name: Lucee WAR deployment tests

on:
  push:
  workflow_dispatch:
    inputs:
      LUCEE_VERSION:
        required: true
        description: Lucee WAR Version to test
        type: string
        default: 6.2.1.122

env:
  TOMCAT_VERSION: 9.0.112
  PUSH_LUCEE_VERSION: 6.2.1.122

jobs:
  test-war-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lucee_version:
          - 6.2.0.321   # known good
          - 6.2.1.122   # reported bad
          - 6.2.4.21-RC # latest RC
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Tomcat
        uses: actions/cache@v4
        with:
          path: apache-tomcat-${{ env.TOMCAT_VERSION }}.tar.gz
          key: tomcat-${{ env.TOMCAT_VERSION }}

      - name: Cache Lucee WAR
        uses: actions/cache@v4
        with:
          path: lucee-${{ matrix.lucee_version }}.war
          key: lucee-war-${{ matrix.lucee_version }}

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ matrix.lucee_version }}
          restore-keys: |
            m2-${{ runner.os }}-

      - name: Download Tomcat
        run: |
          if [ ! -f "apache-tomcat-${{ env.TOMCAT_VERSION }}.tar.gz" ]; then
            curl --fail -sL "https://dlcdn.apache.org/tomcat/tomcat-9/v${{ env.TOMCAT_VERSION }}/bin/apache-tomcat-${{ env.TOMCAT_VERSION }}.tar.gz" -o "apache-tomcat-${{ env.TOMCAT_VERSION }}.tar.gz"
          fi
          ls -lh *.tar.gz

      - name: Download Lucee WAR
        run: |
          if [ ! -f "lucee-${{ matrix.lucee_version }}.war" ]; then
            curl --fail -sL "https://cdn.lucee.org/lucee-${{ matrix.lucee_version }}.war" -o "lucee-${{ matrix.lucee_version }}.war"
          fi
          cp "lucee-${{ matrix.lucee_version }}.war" lucee.war
          ls -lh *.war

      - name: Extract Tomcat and deploy WAR
        run: |
          tar -xzf "apache-tomcat-${{ env.TOMCAT_VERSION }}.tar.gz"
          mv apache-tomcat-${{ env.TOMCAT_VERSION }} tomcat
          cp lucee.war tomcat/webapps/
          ls -la tomcat/webapps/

      - name: Start Tomcat (first boot)
        run: |
          export CATALINA_HOME="$PWD/tomcat"
          chmod +x tomcat/bin/*.sh
          tomcat/bin/startup.sh
          echo "Waiting for Lucee to start..."

          # Wait for WAR to be extracted and Lucee to be ready
          for i in {1..20}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/lucee/lucee/admin/server.cfm 2>/dev/null | grep -qE "(200|302)"; then
              echo "Lucee admin is ready after $i seconds"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done

          # Show what's running and logs
          ps aux | grep -i java || true
          echo "=== catalina.out ==="
          tail -200 tomcat/logs/catalina.out || true
          echo "=== webapps directory ==="
          ls -la tomcat/webapps/
          ls -la tomcat/webapps/lucee/WEB-INF/lucee-server/ || true

      - name: Copy test files
        run: |
          ls -la tomcat/webapps/
          cp webapps-src/*.cfm tomcat/webapps/lucee/
          ls -la tomcat/webapps/lucee/*.cfm

      - name: Test first boot
        run: |
          echo "## Lucee ${{ matrix.lucee_version }} - First Boot" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Version check" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8080/lucee/check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Config check (before restart)" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8080/lucee/config-check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Set admin password" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8080/lucee/set-password.cfm?password=testpass123" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Snapshot config after setting password
          cp tomcat/webapps/lucee/WEB-INF/lucee-server/context/.CFConfig.json /tmp/config-before-restart.json

      - name: Trigger Lucee restart (like admin button)
        run: |
          echo "### Triggering Lucee internal restart" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8080/lucee/restart-lucee.cfm" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Wait for Lucee to come back up
          echo "Waiting for Lucee to restart..."
          sleep 5
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/lucee/check.cfm 2>/dev/null | grep -q "200"; then
              echo "Lucee is ready after $i seconds"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done

      - name: Test after Lucee restart
        run: |
          echo "## Lucee ${{ matrix.lucee_version }} - After Lucee Internal Restart" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Version check" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8080/lucee/check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Password check (after Lucee restart)" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8080/lucee/password-check.cfm" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Snapshot config after Lucee restart
          cp tomcat/webapps/lucee/WEB-INF/lucee-server/context/.CFConfig.json /tmp/config-after-lucee-restart.json

      - name: Full Tomcat restart (JVM restart)
        run: |
          echo "### Stopping Tomcat" | tee -a $GITHUB_STEP_SUMMARY
          tomcat/bin/shutdown.sh || true
          sleep 5

          # Make sure it's dead
          pkill -f "catalina" || true
          sleep 2

          echo "### Starting Tomcat" | tee -a $GITHUB_STEP_SUMMARY
          export CATALINA_HOME="$PWD/tomcat"
          tomcat/bin/startup.sh

          # Wait for Lucee to be ready
          echo "Waiting for Lucee to start after full Tomcat restart..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/lucee/lucee/admin/server.cfm 2>/dev/null | grep -qE "(200|302)"; then
              echo "Lucee is ready after $i seconds"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done

      - name: Test after full Tomcat restart
        run: |
          echo "## Lucee ${{ matrix.lucee_version }} - After Full Tomcat Restart" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Version check" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8080/lucee/check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Config check (after full restart)" | tee -a $GITHUB_STEP_SUMMARY
          HTTP_STATUS=$(curl -s -w "%{http_code}" -o /tmp/config-response.txt http://127.0.0.1:8080/lucee/config-check.cfm)
          cat /tmp/config-response.txt | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "HTTP Status: $HTTP_STATUS" | tee -a $GITHUB_STEP_SUMMARY

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "ERROR: Config check failed with status $HTTP_STATUS - PASSWORD WAS WIPED!" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### Password check (should still be set after JVM restart)" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8080/lucee/password-check.cfm" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Snapshot config after full restart
          cp tomcat/webapps/lucee/WEB-INF/lucee-server/context/.CFConfig.json /tmp/config-after-tomcat-restart.json

      - name: Dump everything
        if: always()
        run: |
          echo "=== .CFConfig.json BEFORE any restart (password/hspw/salt) ==="
          grep -iE "(password|hspw|salt)" /tmp/config-before-restart.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== .CFConfig.json AFTER Lucee restart (password/hspw/salt) ==="
          grep -iE "(password|hspw|salt)" /tmp/config-after-lucee-restart.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== .CFConfig.json AFTER full Tomcat restart (password/hspw/salt) ==="
          grep -iE "(password|hspw|salt)" /tmp/config-after-tomcat-restart.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== Config diff (before vs after Lucee restart) ==="
          diff /tmp/config-before-restart.json /tmp/config-after-lucee-restart.json || true
          echo ""
          echo "=== Config diff (before vs after Tomcat restart) ==="
          diff /tmp/config-before-restart.json /tmp/config-after-tomcat-restart.json || true
          echo ""
          echo "=== lucee err.log ==="
          cat tomcat/webapps/lucee/WEB-INF/lucee-server/context/logs/err.log 2>/dev/null || true
          echo ""
          echo "=== lucee out.log ==="
          cat tomcat/webapps/lucee/WEB-INF/lucee-server/context/logs/out.log 2>/dev/null || true
          echo ""
          echo "=== lucee-server directory ==="
          find tomcat/webapps/lucee/WEB-INF/lucee-server -type f 2>/dev/null | sort

  test-express-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lucee_version:
          - 6.2.0.321   # known good
          - 6.2.1.122   # reported bad
          - 6.2.4.21-RC # latest RC
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Lucee Express
        uses: actions/cache@v4
        with:
          path: lucee-express-${{ matrix.lucee_version }}.zip
          key: lucee-express-${{ matrix.lucee_version }}

      - name: Download Lucee Express
        run: |
          if [ ! -f "lucee-express-${{ matrix.lucee_version }}.zip" ]; then
            curl --fail -sL "https://cdn.lucee.org/lucee-express-${{ matrix.lucee_version }}.zip" -o "lucee-express-${{ matrix.lucee_version }}.zip"
          fi
          ls -lh *.zip

      - name: Extract Express
        run: |
          unzip -q "lucee-express-${{ matrix.lucee_version }}.zip" -d express
          chmod +x express/*.sh 2>/dev/null || true
          chmod +x express/bin/*.sh 2>/dev/null || true
          ls -la express/

      - name: Start Express (first boot)
        run: |
          cd express
          if [ -f "./startup.sh" ]; then
            ./startup.sh &
          else
            ./bin/startup.sh &
          fi
          cd ..
          echo "Waiting for Lucee Express to start..."

          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8888/lucee/admin/server.cfm 2>/dev/null | grep -qE "(200|302)"; then
              echo "Lucee Express is ready after $i seconds"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done

      - name: Copy test files
        run: |
          cp webapps-src/*.cfm express/webapps/ROOT/
          ls -la express/webapps/ROOT/*.cfm

      - name: Test first boot
        run: |
          echo "## Express ${{ matrix.lucee_version }} - First Boot" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Version check" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8888/check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Set admin password" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8888/set-password.cfm?password=testpass123" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Snapshot config after setting password
          cp express/lucee-server/context/.CFConfig.json /tmp/express-config-before-restart.json

      - name: Trigger Lucee restart
        run: |
          echo "### Triggering Lucee internal restart" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8888/restart-lucee.cfm" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "Waiting for Lucee to restart..."
          sleep 5
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8888/check.cfm 2>/dev/null | grep -q "200"; then
              echo "Lucee is ready after $i seconds"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done

      - name: Test after Lucee restart
        run: |
          echo "## Express ${{ matrix.lucee_version }} - After Lucee Internal Restart" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Version check" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8888/check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Password check (after Lucee restart)" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8888/password-check.cfm" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Snapshot config after Lucee restart
          cp express/lucee-server/context/.CFConfig.json /tmp/express-config-after-lucee-restart.json

      - name: Full Express restart (JVM restart)
        run: |
          echo "### Stopping Express" | tee -a $GITHUB_STEP_SUMMARY
          cd express
          if [ -f "./shutdown.sh" ]; then
            ./shutdown.sh || true
          else
            ./bin/shutdown.sh || true
          fi
          cd ..
          sleep 5

          # Make sure it's dead
          pkill -f "catalina" || true
          sleep 2

          echo "### Starting Express" | tee -a $GITHUB_STEP_SUMMARY
          cd express
          if [ -f "./startup.sh" ]; then
            ./startup.sh &
          else
            ./bin/startup.sh &
          fi
          cd ..

          # Wait for Lucee to be ready
          echo "Waiting for Express to start after full restart..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8888/lucee/admin/server.cfm 2>/dev/null | grep -qE "(200|302)"; then
              echo "Express is ready after $i seconds"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done

      - name: Test after full Express restart
        run: |
          echo "## Express ${{ matrix.lucee_version }} - After Full JVM Restart" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Version check" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s http://127.0.0.1:8888/check.cfm | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Config check (after full restart)" | tee -a $GITHUB_STEP_SUMMARY
          HTTP_STATUS=$(curl -s -w "%{http_code}" -o /tmp/express-config-response.txt http://127.0.0.1:8888/config-check.cfm)
          cat /tmp/express-config-response.txt | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "HTTP Status: $HTTP_STATUS" | tee -a $GITHUB_STEP_SUMMARY

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "ERROR: Config check failed with status $HTTP_STATUS - PASSWORD WAS WIPED!" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### Password check (should still be set after JVM restart)" | tee -a $GITHUB_STEP_SUMMARY
          curl --fail -s "http://127.0.0.1:8888/password-check.cfm" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Snapshot config after full restart
          cp express/lucee-server/context/.CFConfig.json /tmp/express-config-after-jvm-restart.json

      - name: Dump Express lucee-server
        if: always()
        run: |
          echo "=== .CFConfig.json BEFORE any restart (password/hspw/salt) ==="
          grep -iE "(password|hspw|salt)" /tmp/express-config-before-restart.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== .CFConfig.json AFTER Lucee restart (password/hspw/salt) ==="
          grep -iE "(password|hspw|salt)" /tmp/express-config-after-lucee-restart.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== .CFConfig.json AFTER full JVM restart (password/hspw/salt) ==="
          grep -iE "(password|hspw|salt)" /tmp/express-config-after-jvm-restart.json 2>/dev/null || echo "File not found"
          echo ""
          echo "=== Config diff (before vs after Lucee restart) ==="
          diff /tmp/express-config-before-restart.json /tmp/express-config-after-lucee-restart.json || true
          echo ""
          echo "=== Config diff (before vs after JVM restart) ==="
          diff /tmp/express-config-before-restart.json /tmp/express-config-after-jvm-restart.json || true
          echo ""
          echo "=== lucee err.log ==="
          cat express/lucee-server/context/logs/err.log 2>/dev/null || true
          echo ""
          echo "=== lucee out.log ==="
          cat express/lucee-server/context/logs/out.log 2>/dev/null || true
          echo ""
          echo "=== Express lucee-server directory ==="
          find express/lucee-server -type f 2>/dev/null | sort || true
